import{C as ue,aa as ce,ba as pe,ca as me}from"./chunk-OAFOHBG2.js";import"./chunk-SZRZRJOS.js";import{a as de}from"./chunk-GPPR4BAL.js";import{a as be}from"./chunk-LNAHWHDB.js";import"./chunk-R3DSXEXQ.js";import{b as R,c as q,f as j,m as z}from"./chunk-UPQQ6FNK.js";import"./chunk-UH4UVRDG.js";import{$b as G,Ca as Y,Eb as k,Fb as N,Ib as Z,Jb as ee,Kb as y,Lb as s,Mb as l,Nb as E,Rb as T,Zb as m,ab as p,fb as ae,jc as F,lb as D,lc as te,oa as d,oc as f,pa as g,pc as A,sc as P,tb as I,tc as B,uc as $}from"./chunk-WZJH74Y7.js";import{a as le,e as _e,h as M}from"./chunk-AQY5CCQG.js";var ve=(_,e)=>e.id;function we(_,e){if(_&1){let t=T();s(0,"button",13),m("click",function(){d(t);let r=G();return g(r.emitDeleteSelected())}),E(1,"i",14),l()}}function Ce(_,e){if(_&1){let t=T();s(0,"button",15),m("click",function(){d(t);let r=G();return g(r.emitAddSelectedToGroup())}),E(1,"i",16),l()}}function ye(_,e){if(_&1){let t=T();s(0,"td",20)(1,"a",24),m("click",function(){d(t);let r=G().$implicit,o=G();return g(o.inspectUser(r))}),E(2,"i",25),l()()}}function Ge(_,e){if(_&1&&(s(0,"span",22),f(1),l()),_&2){let t=G().$implicit;p(),A(t.email)}}function Se(_,e){if(_&1&&(s(0,"span",23),f(1),l()),_&2){let t=G().$implicit;p(),A(t.email)}}function xe(_,e){if(_&1){let t=T();s(0,"tr",17)(1,"td",18)(2,"input",19),m("change",function(){let r=d(t).$implicit,o=G();return g(o.onToggleSelect(r))}),l()(),k(3,ye,3,0,"td",20),s(4,"td",21),k(5,Ge,2,1,"span",22)(6,Se,2,1,"span",23),l()()}if(_&2){let t=e.$implicit,i=G();te("selected-row",t.select),p(2),y("checked",t.select),p(),N(i.show_details?3:-1),p(2),N(t.sin_grupo?5:6)}}var W=class W{constructor(){this.title="Administraci\xF3n de Usuarios";this.show_details=!0;this.can_delete=!1;this.users=[];this.deleteSelected=new I;this.addSelectedToGroup=new I;this.showDetails=new I;this.users_all=[];this.users_visible=[];this.searchTerm=""}ngOnInit(){this.rebuild()}ngOnChanges(e){"users"in e&&this.rebuild()}onToggleSelect(e){e.select=!e.select,this.sortVisible()}inspectUser(e){this.showDetails.emit(e)}emitDeleteSelected(){let e=this.users_visible.filter(t=>t.select);this.deleteSelected.emit(e)}emitAddSelectedToGroup(){let e=this.users_visible.filter(t=>t.select);this.addSelectedToGroup.emit(e)}filterUsers(e){this.searchTerm=(e??"").toString().trim().toLowerCase(),this.applyFilter()}rebuild(){this.users_all=(this.users??[]).map((e,t)=>this.normalizeUser(e,t)),this.applyFilter()}applyFilter(){let e=this.searchTerm,t=e?this.users_all.filter(i=>(i.email??"").toLowerCase().includes(e)):this.users_all.slice();this.users_visible=t,this.sortVisible()}priority(e){return e.select?0:e.sin_grupo?1:2}sortVisible(){this.users_visible.sort((e,t)=>{let i=this.priority(e),r=this.priority(t);if(i!==r)return i-r;let o=(e.email??"").toString(),n=(t.email??"").toString();return o.localeCompare(n,void 0,{sensitivity:"base"})})}normalizeUser(e,t){let i=(e?.email??e?.username??"").toString(),r=Number(e?.item_id??e?.id),o=Number.isFinite(r)&&r>0?r:t+1,n;return typeof e?.sin_grupo=="boolean"?n=e.sin_grupo:Array.isArray(e?.groups)?n=e.groups.length===0:n=!1,{id:o,item_id:r||o,email:i,select:!!e?.select,sin_grupo:n,groups:Array.isArray(e?.groups)?e.groups:void 0,username:e?.username}}};W.\u0275fac=function(t){return new(t||W)},W.\u0275cmp=D({type:W,selectors:[["app-users"]],inputs:{title:"title",show_details:"show_details",can_delete:"can_delete",users:"users"},outputs:{deleteSelected:"deleteSelected",addSelectedToGroup:"addSelectedToGroup",showDetails:"showDetails"},features:[Y],decls:16,vars:2,consts:[["q",""],[1,"p-4","border","rounded","shadow-sm","bg-white","panel-usuarios","d-flex","flex-column"],[1,"mb-3"],[1,"d-flex","align-items-center","gap-2","mb-3","toolbar"],["type","button","aria-label","Eliminar usuarios seleccionados del grupo","title","Eliminar usuarios seleccionados del grupo",1,"btn","btn-danger","d-flex","align-items-center"],["type","button","aria-label","Agregar usuarios seleccionados a un grupo","title","Agregar usuarios seleccionados a un grupo",1,"btn","btn-success","d-flex","align-items-center"],[1,"input-group","ms-2","toolbar-search"],["type","text","placeholder","Buscar...","aria-label","Buscar",1,"form-control",3,"input"],["type","button","aria-label","Buscar",1,"btn","btn-outline-secondary",3,"click"],[1,"fas","fa-search"],[1,"table-wrapper","flex-grow-1","overflow-auto"],[1,"table","custom-table","w-100","m-0","align-middle"],[1,"custom-row",3,"selected-row"],["type","button","aria-label","Eliminar usuarios seleccionados del grupo","title","Eliminar usuarios seleccionados del grupo",1,"btn","btn-danger","d-flex","align-items-center",3,"click"],[1,"fa-solid","fa-trash","me-1"],["type","button","aria-label","Agregar usuarios seleccionados a un grupo","title","Agregar usuarios seleccionados a un grupo",1,"btn","btn-success","d-flex","align-items-center",3,"click"],[1,"fa-solid","fa-list-ul","me-1"],[1,"custom-row"],[1,"check-cell"],["type","checkbox",1,"form-check-input",3,"change","checked"],[1,"icon-cell"],[1,"custom-cell"],[1,"user-email","user--sin-grupo"],[1,"user-email"],["role","button","title","Ver Detalles","aria-label","Ver Detalles",1,"eye-link","text-decoration-none",3,"click"],[1,"fa-regular","fa-eye"]],template:function(t,i){if(t&1){let r=T();s(0,"div",1)(1,"h4",2),f(2),l(),s(3,"div",3),k(4,we,2,0,"button",4)(5,Ce,2,0,"button",5),s(6,"div",6)(7,"input",7,0),m("input",function(){d(r);let n=F(8);return g(i.filterUsers(n.value))}),l(),s(9,"button",8),m("click",function(){d(r);let n=F(8);return g(i.filterUsers(n.value))}),E(10,"i",9),l()()(),s(11,"div",10)(12,"table",11)(13,"tbody"),Z(14,xe,7,5,"tr",12,ve),l()()()()}t&2&&(p(2),A(i.title),p(2),N(i.can_delete?4:5),p(10),ee(i.users_visible))},styles:['@charset "UTF-8";.toolbar[_ngcontent-%COMP%]   .toolbar-search[_ngcontent-%COMP%]{min-width:220px;flex:1}.table-wrapper[_ngcontent-%COMP%]{max-height:50vh;overflow:auto}.icon-cell[_ngcontent-%COMP%], .check-cell[_ngcontent-%COMP%]{width:42px;text-align:center}.eye-link[_ngcontent-%COMP%], .eye-link[_ngcontent-%COMP%]:visited, .eye-link[_ngcontent-%COMP%]:active{color:var(--bs-dark)!important}.eye-link[_ngcontent-%COMP%]:hover{color:var(--bs-primary)!important}.panel-usuarios[_ngcontent-%COMP%]{min-height:420px}.table.custom-table[_ngcontent-%COMP%]   :where(td[_ngcontent-%COMP%], th[_ngcontent-%COMP%]){border:0}.custom-row[_ngcontent-%COMP%]{border-bottom:1px solid #f1f3f5;transition:background-color .2s ease}.custom-row[_ngcontent-%COMP%]:last-child{border-bottom:0}.custom-row[_ngcontent-%COMP%]:hover{background-color:#f6f7f9}.user-email[_ngcontent-%COMP%]{color:#000;font-weight:400}.user--sin-grupo[_ngcontent-%COMP%]{font-weight:700;color:#cf0606}.selected-row[_ngcontent-%COMP%]{background-color:#e9f5ff;color:#000}.selected-row[_ngcontent-%COMP%]   .user-email[_ngcontent-%COMP%]{font-weight:700}']});var L=W;var Te=(_,e)=>e.grupo;function Ue(_,e){if(_&1){let t=T();s(0,"button",12),m("click",function(){d(t);let r=G();return g(r.deleteGroupsSelected())}),E(1,"i",13),l()}}function Ie(_,e){if(_&1){let t=T();s(0,"td",17)(1,"a",20),m("click",function(){d(t);let r=G().$implicit,o=G();return g(o.inspectGroup(r))}),E(2,"i",21),l()()}}function Ee(_,e){if(_&1){let t=T();s(0,"tr",14)(1,"td",15)(2,"input",16),m("change",function(){let r=d(t).$implicit,o=G();return g(o.onToggleSelect(r))}),l()(),k(3,Ie,3,0,"td",17),s(4,"td",18)(5,"span",19),f(6),l()()()}if(_&2){let t=e.$implicit,i=G();te("selected-row",t.select),p(2),y("checked",t.select),p(),N(i.show_details?3:-1),p(3),A(t.grupo)}}var H=class H{constructor(){this.groups=[];this.show_details=!1;this.can_delete=!0;this.title="Administraci\xF3n de Grupos";this.deleteGroups=new I;this.showDetails=new I;this.goupsSelected=new I;this.groups_all=[];this.groups_visible=[];this.searchTerm=""}ngOnChanges(e){e.groups&&(this.groups_all=Array.isArray(this.groups)?[...this.groups]:[],this.filterGroups(this.searchTerm))}filterGroups(e){this.searchTerm=(e??this.searchTerm??"").trim();let t=this.normalize(this.searchTerm);if(!t){this.groups_visible=[...this.groups_all],this.sortVisible();return}this.groups_visible=this.groups_all.filter(i=>this.normalize(i?.grupo).includes(t)),this.sortVisible()}priority(e){return e.select?0:1}sortVisible(){this.groups_visible.sort((e,t)=>{let i=this.priority(e),r=this.priority(t);if(i!==r)return i-r;let o=(e.grupo??"").toString(),n=(t.grupo??"").toString();return this.normalize(o).localeCompare(this.normalize(n),void 0,{sensitivity:"base"})})}normalize(e){return(e??"").toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"")}onToggleSelect(e){e.select=!e.select,this.sortVisible(),this.reportSelectedGroups()}reportSelectedGroups(){this.goupsSelected.emit(this.groups_all.filter(e=>e.select))}deleteGroupsSelected(){this.deleteGroups.emit(this.groups_all.filter(e=>e.select))}inspectGroup(e){this.showDetails.emit(e)}};H.\u0275fac=function(t){return new(t||H)},H.\u0275cmp=D({type:H,selectors:[["app-groups"]],inputs:{groups:"groups",show_details:"show_details",can_delete:"can_delete",title:"title"},outputs:{deleteGroups:"deleteGroups",showDetails:"showDetails",goupsSelected:"goupsSelected"},features:[Y],decls:15,vars:2,consts:[["q",""],[1,"p-4","border","rounded","shadow-sm","bg-white","panel-usuarios","d-flex","flex-column"],[1,"mb-3"],[1,"d-flex","align-items-center","gap-2","mb-3","toolbar"],["type","button","aria-label","Eliminar grupos seleccionados","title","Eliminar grupos seleccionados",1,"btn","btn-danger","d-flex","align-items-center"],[1,"input-group","ms-2","toolbar-search"],["type","text","placeholder","Buscar...","aria-label","Buscar",1,"form-control",3,"input"],["type","button","aria-label","Buscar",1,"btn","btn-outline-secondary",3,"click"],[1,"fas","fa-search"],[1,"table-wrapper","flex-grow-1","overflow-auto"],[1,"table","custom-table","w-100","m-0","align-middle"],[1,"custom-row",3,"selected-row"],["type","button","aria-label","Eliminar grupos seleccionados","title","Eliminar grupos seleccionados",1,"btn","btn-danger","d-flex","align-items-center",3,"click"],[1,"fa-solid","fa-trash","me-1"],[1,"custom-row"],[1,"check-cell"],["type","checkbox",1,"form-check-input",3,"change","checked"],[1,"icon-cell"],[1,"custom-cell"],[1,"group-name"],["role","button","title","Ver Detalles","aria-label","Ver Detalles",1,"eye-link","text-decoration-none",3,"click"],[1,"fa-regular","fa-eye"]],template:function(t,i){if(t&1){let r=T();s(0,"div",1)(1,"h4",2),f(2),l(),s(3,"div",3),k(4,Ue,2,0,"button",4),s(5,"div",5)(6,"input",6,0),m("input",function(){d(r);let n=F(7);return g(i.filterGroups(n.value))}),l(),s(8,"button",7),m("click",function(){d(r);let n=F(7);return g(i.filterGroups(n.value))}),E(9,"i",8),l()()(),s(10,"div",9)(11,"table",10)(12,"tbody"),Z(13,Ee,7,5,"tr",11,Te),l()()()()}t&2&&(p(2),A(i.title),p(2),N(i.can_delete?4:-1),p(9),ee(i.groups_visible))},styles:['@charset "UTF-8";.toolbar[_ngcontent-%COMP%]   .toolbar-search[_ngcontent-%COMP%]{min-width:220px;flex:1}.table-wrapper[_ngcontent-%COMP%]{max-height:50vh;overflow:auto}.icon-cell[_ngcontent-%COMP%], .check-cell[_ngcontent-%COMP%]{width:42px;text-align:center}.eye-link[_ngcontent-%COMP%], .eye-link[_ngcontent-%COMP%]:visited, .eye-link[_ngcontent-%COMP%]:active{color:var(--bs-dark)!important}.eye-link[_ngcontent-%COMP%]:hover{color:var(--bs-primary)!important}.panel-usuarios[_ngcontent-%COMP%]{min-height:420px}.table.custom-table[_ngcontent-%COMP%]   :where(td[_ngcontent-%COMP%], th[_ngcontent-%COMP%]){border:0}.custom-row[_ngcontent-%COMP%]{border-bottom:1px solid #f1f3f5;transition:background-color .2s ease}.custom-row[_ngcontent-%COMP%]:last-child{border-bottom:0}.custom-row[_ngcontent-%COMP%]:hover{background-color:#f6f7f9}.group-name[_ngcontent-%COMP%]{color:#000;font-weight:400}.selected-row[_ngcontent-%COMP%]{background-color:#e9f5ff;color:#000}.selected-row[_ngcontent-%COMP%]   .group-name[_ngcontent-%COMP%]{font-weight:700}']});var Q=H;var K=class K{constructor(){this._user={email:"",groups:[]};this.groupsForChild=[];this.deleteGroups=new I}set user(e){this._user=e??{email:"",groups:[]},this.groupsForChild=(this._user.groups??[]).map(t=>({grupo:t,select:!1}))}get user(){return this._user}onDeleteGroups(e){let t={user:this.user,groups_to_delete:e};this.deleteGroups.emit(t)}};K.\u0275fac=function(t){return new(t||K)},K.\u0275cmp=D({type:K,selectors:[["app-user-details"]],inputs:{user:"user"},outputs:{deleteGroups:"deleteGroups"},decls:15,vars:4,consts:[[1,"row"],[1,"col-12"],[1,"p-4","border","rounded","shadow-sm","bg-white"],[1,"mb-3"],["for","emailInput",1,"form-label"],["id","emailInput","aria-describedby","emailInput","placeholder","Correo Electr\xF3nico del Usuario",1,"form-control",3,"ngModelChange","ngModel"],["id","mensajeHelp",1,"form-text","text-muted"],["for","userGroups",1,"form-label"],[3,"deleteGroups","show_details","groups","title"]],template:function(t,i){t&1&&(s(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"label",4),f(5,"Correo Electr\xF3nico"),l(),s(6,"input",5),$("ngModelChange",function(o){return B(i.user.email,o)||(i.user.email=o),o}),l(),s(7,"small",6),f(8," Correo Electr\xF3nico del Usuario. "),l()(),s(9,"div",3)(10,"label",7),f(11,"Grupos a los que pertenece"),l(),s(12,"app-groups",8),m("deleteGroups",function(o){return i.onDeleteGroups(o)}),l(),s(13,"small",6),f(14," Grupos a los que pertenece el Usuario. "),l()()()()()),t&2&&(p(6),P("ngModel",i.user.email),p(6),y("show_details",!1)("groups",i.groupsForChild)("title","Grupos del Usuario"))},dependencies:[z,R,q,j,Q],encapsulation:2});var oe=K;var X=class X{constructor(){this._group={grupo:"",members:[]};this.usersForChild=[];this.deleteUsers=new I}set group(e){this._group=e??{grupo:"",members:[]},this.usersForChild=(this._group.members??[]).map(t=>{let i=(t.email||"").split("@")[0]||t.email;return{id:Number(t.item_id??0),email:t.email,item_id:t.item_id,select:!1,name:t.email,username:i}})}get group(){return this._group}onDeleteUsers(e){let t={group:this.group,users_to_delete:e};this.deleteUsers.emit(t)}};X.\u0275fac=function(t){return new(t||X)},X.\u0275cmp=D({type:X,selectors:[["app-group-details"]],inputs:{group:"group"},outputs:{deleteUsers:"deleteUsers"},decls:15,vars:5,consts:[[1,"row"],[1,"col-12"],[1,"p-4","border","rounded","shadow-sm","bg-white"],[1,"mb-3"],["for","nombreGrupo",1,"form-label"],["id","nombreGrupo","aria-describedby","nombreGrupo","placeholder","Nombre del Grupo",1,"form-control",3,"ngModelChange","ngModel"],["id","mensajeHelp",1,"form-text","text-muted"],["for","groupMembers",1,"form-label"],[3,"deleteSelected","users","show_details","can_delete","title"]],template:function(t,i){t&1&&(s(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"label",4),f(5,"Nombre"),l(),s(6,"input",5),$("ngModelChange",function(o){return B(i.group.grupo,o)||(i.group.grupo=o),o}),l(),s(7,"small",6),f(8," Nombre del Grupo. "),l()(),s(9,"div",3)(10,"label",7),f(11,"Miembros del Grupo"),l(),s(12,"app-users",8),m("deleteSelected",function(o){return i.onDeleteUsers(o)}),l(),s(13,"small",6),f(14," Usuarios que pertenecen al Grupo. "),l()()()()()),t&2&&(p(6),P("ngModel",i.group.grupo),p(6),y("users",i.usersForChild)("show_details",!1)("can_delete",!0)("title","Usuarios en el Grupo"))},dependencies:[z,R,q,j,L],encapsulation:2});var ne=X;var C=_e(be());var J=class J{constructor(e){this.catalogService=e;this.visibleUserDetails=!1;this.visibleGroupDetails=!1;this.visibleAddUsersToGroup=!1;this.loading=!1;this.toAddUsers=[];this.users=[];this.users_groups=[];this.groupsToAdd=[];this.newGroupName="";this.user_selected=null;this.group_selected=null;this.groups=[];this.emailToId=new Map;this.norm=e=>(e??"").toString().trim().toLowerCase();this.local=e=>{let t=e.indexOf("@");return t>=0?e.slice(0,t):e}}ngOnInit(){return M(this,null,function*(){yield this.getUsers()})}buildEmailIndex(){this.emailToId.clear();for(let e of this.users??[]){let t=Number(e?.item_id??e?.id??0),i=this.norm(e?.email),r=this.norm(e?.username);i&&(this.emailToId.set(i,t),this.emailToId.set(this.norm(this.local(i)),t)),r&&(this.emailToId.set(r,t),this.emailToId.set(this.norm(this.local(r)),t))}}lookupItemId(e){let t=this.norm(e),i=this.norm(this.local(e));return this.emailToId.get(t)??this.emailToId.get(i)??0}buildUserItem(e){let t=e?.email??e?.username??"",i=this.lookupItemId(t),r=new Set;for(let o of this.users_groups??[]){let n=o?.email??o?.username??"",b=this.norm(n),u=this.norm(this.local(n)),U=this.norm(t),c=this.norm(this.local(t));if(b===U||u===c){let S=o?.group??o?.grupo;S&&r.add(S)}}return{item_id:i||void 0,name:e?.name??e?.nombre??e?.username??void 0,email:t,groups:Array.from(r)}}buildGroupItem(e){let t=typeof e=="string"?e:e?.grupo??e?.group??"Sin grupo",i=new Map;for(let r of this.users_groups??[]){if((r?.group??r?.grupo??"")!==t)continue;let n=r?.email??r?.username??"",b=this.norm(n)||this.norm(this.local(n))||n;i.has(b)||i.set(b,{email:n,item_id:this.lookupItemId(n)})}return{grupo:t,members:Array.from(i.values())}}getUsers(){return M(this,null,function*(){this.loading=!0;try{let{response:e}=yield this.catalogService.list("users");this.users=e??[],this.buildEmailIndex(),yield this.getUsersGroups()}catch(e){console.error("Error cargando Usuarios:",e),this.users=[],this.emailToId.clear()}finally{this.loading=!1}})}getUsersGroups(){return M(this,null,function*(){this.loading=!0;try{let{response:e}=yield this.catalogService.list("usersgroup");this.users_groups=e??[],this.build_groups(),this.buscar_usuarios_huerfanos()}catch(e){console.error("Error cargando UsersGroup:",e),this.users_groups=[],this.groups=[]}finally{this.loading=!1}})}build_groups(){let e=new Map;for(let t of this.users_groups??[]){let i=t?.group??t?.grupo??"Sin grupo",r=t?.email??t?.username??"",o=this.norm(r),n=this.norm(this.local(r)),b=this.lookupItemId(r);e.has(i)||e.set(i,new Map);let u=e.get(i),U=o||n||r;u.has(U)||u.set(U,{email:r,item_id:b})}this.groups=Array.from(e.entries()).map(([t,i])=>({grupo:t,select:!1,miembros:Array.from(i.values())}))}buscar_usuarios_huerfanos(){let e=new Set;for(let t of this.users_groups??[]){let i=(t?.email??t?.username??"").toString(),r=this.norm(i),o=this.norm(this.local(i));r&&e.add(r),o&&e.add(o)}for(let t of this.users??[]){let i=(t?.email??t?.username??"").toString(),r=this.norm(i),o=this.norm(this.local(i)),n=e.has(r)||e.has(o);t.sin_grupo=!n}this.users=this.users.map(t=>le({},t))}handleChangeVisibleAddUsersToGroup(e){}handleChangeVisibleUserDetails(e){}cancelarUserDetails(){this.visibleUserDetails=!1}handleChangeVisibleGroupDetails(e){}cancelarGroupDetails(){this.visibleGroupDetails=!1}showUserDetail(e){this.user_selected=this.buildUserItem(e),this.visibleUserDetails=!0}showGroupDetail(e){this.group_selected=this.buildGroupItem(e),this.visibleGroupDetails=!0}deleteSelectedGroups(e){return M(this,null,function*(){try{let t=(e??[]).map(u=>(u?.grupo??u)?.toString().trim()).filter(Boolean);if(!t.length){yield C.default.fire({icon:"info",title:"Sin grupos seleccionados",text:"Selecciona al menos un grupo para continuar."});return}if(!(yield C.default.fire({icon:"warning",title:"\xBFEliminar asignaciones de estos grupos?",html:`
          <div class="text-start">
            <p>Se eliminar\xE1n los siguientes grupos:</p>
            <ul style="text-align:left; max-height:180px; overflow:auto; margin:0;">
              ${t.map(u=>`<li><code>${u}</code></li>`).join("")}
            </ul>
            <p class="mt-2"><b>Esta acci\xF3n no se puede deshacer.</b></p>
          </div>
        `,showCancelButton:!0,confirmButtonText:"S\xED, eliminar",cancelButtonText:"Cancelar",reverseButtons:!0,confirmButtonColor:"#d33"})).isConfirmed)return;this.loading=!0;let r=(this.users_groups??[]).filter(u=>t.includes((u?.group??u?.grupo??"").toString().trim())).map(u=>Number(u?.item_id??u?.id)).filter(u=>Number.isFinite(u)&&u>0);if(!r.length){yield C.default.fire({icon:"info",title:"No hay asignaciones que eliminar",text:"No se encontraron documentos en usersgroup para los grupos seleccionados."});return}let o=yield Promise.allSettled(r.map(u=>this.catalogService.delete("usersgroup",u))),n=o.filter(u=>u.status==="fulfilled").length,b=o.length-n;yield this.getUsersGroups(),yield C.default.fire({icon:b?"warning":"success",title:b?"Eliminaci\xF3n parcial":"Eliminaci\xF3n completada",html:`
          <div class="text-start">
            <p><b>Intentos:</b> ${o.length}</p>
            <p><b>Eliminados:</b> ${n}</p>
            <p><b>Fallidos:</b> ${b}</p>
          </div>
        `})}catch(t){console.error("Error al eliminar grupos:",t),yield C.default.fire({icon:"error",title:"Error",text:"Ocurri\xF3 un problema eliminando las asignaciones. Revisa la consola para m\xE1s detalles."})}finally{this.loading=!1}})}deleteUsersGroup(e){return M(this,null,function*(){try{let t=!!e?.user&&Array.isArray(e?.groups_to_delete),i=!!e?.grupo&&Array.isArray(e?.usuarios_to_delete);if(!t&&!i){yield C.default.fire({icon:"info",title:"Datos insuficientes",text:"No se reconoce el formato del evento recibido."});return}let r=h=>(h??[]).map(x=>(x?.grupo??x?.group??"").toString().trim()).filter(Boolean),o=[],n="",b="",u=()=>{};if(t){let h=e.user?.email??e.user?.username??"",x=r(e.groups_to_delete);if(!h||!x.length){yield C.default.fire({icon:"info",title:"Nada que eliminar",text:"Faltan el usuario o los grupos a eliminar."});return}n="\xBFQuitar usuario de los grupos seleccionados?",b=`
          <div class="text-start">
            <p><b>Usuario:</b> <code>${h}</code></p>
            <p><b>Grupos:</b></p>
            <ul style="text-align:left;max-height:180px;overflow:auto;margin:0;">
              ${x.map(w=>`<li><code>${w}</code></li>`).join("")}
            </ul>
            <p class="mt-2"><b>Esta acci\xF3n no se puede deshacer.</b></p>
          </div>
        `;let O=this.norm(h),v=this.norm(this.local(h));o=(this.users_groups??[]).filter(w=>x.includes((w?.group??w?.grupo??"").toString().trim())).filter(w=>{let V=w?.email??w?.username??"",se=this.norm(V),fe=this.norm(this.local(V));return se===O||fe===v}).map(w=>Number(w?.item_id??w?.id)).filter(w=>Number.isFinite(w)&&w>0),u=()=>{this.visibleUserDetails&&(this.user_selected=this.buildUserItem(e.user))}}else{let h=(e?.grupo??e?.group??"").toString().trim(),x=(e?.usuarios_to_delete??[]).map(v=>(v?.email??v?.username??"").toString().trim()).filter(Boolean);if(!h||!x.length){yield C.default.fire({icon:"info",title:"Nada que eliminar",text:"Faltan el grupo o los usuarios a eliminar."});return}n="\xBFQuitar usuarios del grupo seleccionado?",b=`
          <div class="text-start">
            <p><b>Grupo:</b> <code>${h}</code></p>
            <p><b>Usuarios:</b></p>
            <ul style="text-align:left;max-height:180px;overflow:auto;margin:0;">
              ${x.map(v=>`<li><code>${v}</code></li>`).join("")}
            </ul>
            <p class="mt-2"><b>Esta acci\xF3n no se puede deshacer.</b></p>
          </div>
        `;let O=new Set;for(let v of x){let w=this.norm(v),V=this.norm(this.local(v));w&&O.add(w),V&&O.add(V)}o=(this.users_groups??[]).filter(v=>(v?.group??v?.grupo??"")===h).filter(v=>{let w=v?.email??v?.username??"",V=this.norm(w),se=this.norm(this.local(w));return O.has(V)||O.has(se)}).map(v=>Number(v?.item_id??v?.id)).filter(v=>Number.isFinite(v)&&v>0),u=()=>{this.visibleGroupDetails&&(this.group_selected=this.buildGroupItem(h))}}if(!o.length){yield C.default.fire({icon:"info",title:"No hay asignaciones coincidentes",text:"No se encontraron documentos en usersgroup que cumplan con los filtros."});return}if(!(yield C.default.fire({icon:"warning",title:n,html:b,showCancelButton:!0,confirmButtonText:"S\xED, eliminar",cancelButtonText:"Cancelar",reverseButtons:!0,confirmButtonColor:"#d33"})).isConfirmed)return;this.loading=!0;let c=yield Promise.allSettled(o.map(h=>this.catalogService.delete("usersgroup",h))),S=c.filter(h=>h.status==="fulfilled").length,a=c.length-S;yield this.getUsersGroups(),u(),yield C.default.fire({icon:a?"warning":"success",title:a?"Eliminaci\xF3n parcial":"Eliminaci\xF3n completada",html:`
          <div class="text-start">
            <p><b>Intentos:</b> ${c.length}</p>
            <p><b>Eliminados:</b> ${S}</p>
            <p><b>Fallidos:</b> ${a}</p>
          </div>
        `})}catch(t){console.error("Error en deleteUsersGroup:",t),yield C.default.fire({icon:"error",title:"Error",text:"Ocurri\xF3 un problema eliminando las asignaciones. Revisa la consola para m\xE1s detalles."})}finally{this.visibleUserDetails=!1,this.loading=!1}})}deleteGroupsUser(e){return M(this,null,function*(){try{let t=(e?.group?.grupo??e?.group?.group??e?.group??"").toString().trim(),i=(e?.users_to_delete??[]).map(c=>(c?.email??c?.username??"").toString().trim()).filter(Boolean);if(!t||!i.length){yield C.default.fire({icon:"info",title:"Nada que eliminar",text:"Faltan el grupo o los usuarios a eliminar."});return}if(!(yield C.default.fire({icon:"warning",title:"\xBFQuitar usuarios del grupo?",html:`
          <div class="text-start">
            <p><b>Grupo:</b> <code>${t}</code></p>
            <p><b>Usuarios:</b></p>
            <ul style="text-align:left;max-height:180px;overflow:auto;margin:0;">
              ${i.map(c=>`<li><code>${c}</code></li>`).join("")}
            </ul>
            <p class="mt-2"><b>Esta acci\xF3n no se puede deshacer.</b></p>
          </div>
        `,showCancelButton:!0,confirmButtonText:"S\xED, eliminar",cancelButtonText:"Cancelar",reverseButtons:!0,confirmButtonColor:"#d33"})).isConfirmed)return;this.loading=!0;let o=new Set;for(let c of i){let S=this.norm(c),a=this.norm(this.local(c));S&&o.add(S),a&&o.add(a)}let n=(this.users_groups??[]).filter(c=>(c?.group??c?.grupo??"").toString().trim()===t).filter(c=>{let S=(c?.email??c?.username??"").toString(),a=this.norm(S),h=this.norm(this.local(S));return o.has(a)||o.has(h)}).map(c=>Number(c?.item_id??c?.id)).filter(c=>Number.isFinite(c)&&c>0);if(!n.length){yield C.default.fire({icon:"info",title:"No hay asignaciones coincidentes",text:"No se encontraron documentos en usersgroup que cumplan con los filtros."});return}let b=yield Promise.allSettled(n.map(c=>this.catalogService.delete("usersgroup",c))),u=b.filter(c=>c.status==="fulfilled").length,U=b.length-u;yield this.getUsersGroups(),this.visibleGroupDetails&&(this.group_selected=this.buildGroupItem(t)),yield C.default.fire({icon:U?"warning":"success",title:U?"Eliminaci\xF3n parcial":"Eliminaci\xF3n completada",html:`
          <div class="text-start">
            <p><b>Intentos:</b> ${b.length}</p>
            <p><b>Eliminados:</b> ${u}</p>
            <p><b>Fallidos:</b> ${U}</p>
          </div>
        `})}catch(t){console.error("Error en deleteGroupsUser:",t),yield C.default.fire({icon:"error",title:"Error",text:"Ocurri\xF3 un problema eliminando las asignaciones. Revisa la consola para m\xE1s detalles."})}finally{this.loading=!1,this.visibleGroupDetails=!1}})}addUsersToGroup(e){this.visibleAddUsersToGroup=!0,this.toAddUsers=e}groupsToAddReport(e){this.groupsToAdd=e}cancelarAddUsersToGroup(){this.groupsToAdd=[],this.newGroupName="",this.visibleAddUsersToGroup=!1}addUsersToGroups(){return M(this,null,function*(){try{let e=(this.toAddUsers??[]).map(a=>(a?.email??a?.username??"").toString().trim()).filter(Boolean),t=Array.from(new Set(e));if(!t.length){console.log("[addUsersToGroups] No hay usuarios seleccionados.");return}let i=Array.isArray(this.groupsToAdd)&&this.groupsToAdd.length?this.groupsToAdd.map(a=>(a?.grupo??a?.group??"").toString().trim()):(this.groups??[]).filter(a=>!!a?.select).map(a=>(a?.grupo??a?.group??"").toString().trim()),r=(this.newGroupName??"").toString().trim();if(r&&i.push(r),i=Array.from(new Set(i)).filter(Boolean),!i.length){console.log("[addUsersToGroups] No hay grupos seleccionados/ingresados.");return}let o=(a,h)=>`${this.norm(a)}|${this.norm(h)}`,n=(a,h)=>`${this.norm(a)}|${this.norm(this.local(h))}`,b=new Set;for(let a of this.users_groups??[]){let h=(a?.group??a?.grupo??"").toString(),x=(a?.email??a?.username??"").toString();!h||!x||(b.add(o(h,x)),b.add(n(h,x)))}let u=[];for(let a of t)for(let h of i)!b.has(o(h,a))&&!b.has(n(h,a))&&u.push({group:h,email:a});if(!u.length){console.log("[addUsersToGroups] No hay nuevas asignaciones por crear (todas existen)."),this.visibleAddUsersToGroup=!1;return}this.loading=!0;let U=yield Promise.allSettled(u.map(a=>this.catalogService.create("usersgroup",a))),c=U.filter(a=>a.status==="fulfilled").length,S=U.length-c;yield this.getUsersGroups(),this.visibleAddUsersToGroup=!1,this.toAddUsers=[],this.groupsToAdd=[],this.newGroupName="",console.log(`[addUsersToGroups] Creaci\xF3n completada. \xC9xitos: ${c}, Fallos: ${S}`)}catch(e){console.error("[addUsersToGroups] Error:",e)}finally{this.loading=!1}})}};J.\u0275fac=function(t){return new(t||J)(ae(de))},J.\u0275cmp=D({type:J,selectors:[["app-receiver"]],decls:52,vars:14,consts:[["modalXl",""],[1,"container"],[1,"row"],[1,"col-12","mb-4"],[1,"row","mb-5"],[1,"col-6"],[3,"showDetails","addSelectedToGroup","show_details","users","can_delete"],[3,"showDetails","deleteGroups","show_details","groups"],["id","modal","size","lg",3,"visibleChange","visible"],["cButtonClose","",3,"click"],[3,"deleteGroups","user"],[3,"deleteUsers","group"],[1,"mb-3"],["for","newGroupName",1,"form-label"],["type","text","id","newGroupName","placeholder","Nombre del Nuevo Grupo",1,"form-control",3,"ngModelChange","ngModel"],[1,"form-text","text-muted"],["for","existingGroup",1,"form-label"],[3,"goupsSelected","groups","can_delete","title"],[1,"d-flex","justify-content-center","align-items-center","gap-2","mt-4"],["role","group","aria-label","Toolbar de acciones",1,"btn-group"],["type","button",1,"btn","btn-dark",3,"click"],[1,"fas","fa-save"],["type","button",1,"btn","btn-outline-danger",3,"click"],[1,"fas","fa-times"]],template:function(t,i){if(t&1){let r=T();s(0,"div",1)(1,"div",2)(2,"h1",3),f(3," Administraci\xF3n de Grupos "),l(),s(4,"small",3),f(5,"Permite la gesti\xF3n de los grupos que recibiran los mensajes que se remitan con la plataforma de Comunicaci\xF3n de Grupo KFC"),l()(),s(6,"div",4)(7,"div",5)(8,"app-users",6),m("showDetails",function(n){return d(r),g(i.showUserDetail(n))})("addSelectedToGroup",function(n){return d(r),g(i.addUsersToGroup(n))}),l()(),s(9,"div",5)(10,"app-groups",7),m("showDetails",function(n){return d(r),g(i.showGroupDetail(n))})("deleteGroups",function(n){return d(r),g(i.deleteSelectedGroups(n))}),l()()()(),s(11,"c-modal",8,0),m("visibleChange",function(n){return d(r),g(i.handleChangeVisibleUserDetails(n))}),s(13,"c-modal-header")(14,"h3"),f(15,"Datos del Usuario"),l(),s(16,"button",9),m("click",function(){return d(r),g(i.cancelarUserDetails())}),l()(),s(17,"c-modal-body")(18,"app-user-details",10),m("deleteGroups",function(n){return d(r),g(i.deleteUsersGroup(n))}),l()()(),s(19,"c-modal",8,0),m("visibleChange",function(n){return d(r),g(i.handleChangeVisibleGroupDetails(n))}),s(21,"c-modal-header")(22,"h3"),f(23,"Datos del Grupo"),l(),s(24,"button",9),m("click",function(){return d(r),g(i.cancelarGroupDetails())}),l()(),s(25,"c-modal-body")(26,"app-group-details",11),m("deleteUsers",function(n){return d(r),g(i.deleteGroupsUser(n))}),l()()(),s(27,"c-modal",8,0),m("visibleChange",function(n){return d(r),g(i.handleChangeVisibleAddUsersToGroup(n))}),s(29,"c-modal-header")(30,"h3"),f(31,"Agregar Usuarios a Grupo"),l(),s(32,"button",9),m("click",function(){return d(r),g(i.cancelarAddUsersToGroup())}),l()(),s(33,"c-modal-body")(34,"div",12)(35,"label",13),f(36,"Agregar a un Grupo Nuevo"),l(),s(37,"input",14),$("ngModelChange",function(n){return d(r),B(i.newGroupName,n)||(i.newGroupName=n),g(n)}),l(),s(38,"small",15),f(39,"Nuevo Grupo a Crear."),l()(),s(40,"div",12)(41,"label",16),f(42,"Agregar a un Grupo Existente"),l(),s(43,"app-groups",17),m("goupsSelected",function(n){return d(r),g(i.groupsToAddReport(n))}),l()(),s(44,"div",18)(45,"div",19)(46,"button",20),m("click",function(){return d(r),g(i.addUsersToGroups())}),E(47,"i",21),f(48," Guardar "),l(),s(49,"button",22),m("click",function(){return d(r),g(i.cancelarAddUsersToGroup())}),E(50,"i",23),f(51," Cancelar "),l()()()()()}t&2&&(p(8),y("show_details",!0)("users",i.users)("can_delete",!1),p(2),y("show_details",!0)("groups",i.groups),p(),y("visible",i.visibleUserDetails),p(7),y("user",i.user_selected),p(),y("visible",i.visibleGroupDetails),p(7),y("group",i.group_selected),p(),y("visible",i.visibleAddUsersToGroup),p(10),P("ngModel",i.newGroupName),p(6),y("groups",i.groups)("can_delete",!1)("title","Grupos"))},dependencies:[z,R,q,j,ce,me,pe,oe,ne,L,Q,ue],encapsulation:2});var he=J;export{he as ReceiverComponent};
